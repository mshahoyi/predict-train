name: ft_daemon

resources:
  cloud: runpod
  accelerators: H100-SXM:2
  cpus: 8+
  memory: 32+
  disk_size: 1000
  image_id: 'runpod/pytorch:2.4.0-py3.11-cuda12.4.1-devel-ubuntu22.04'
  region: US

# Number of nodes to launch
num_nodes: 1

# Files to sync
workdir: .

file_mounts:
  ~/sky_workdir/.env: .env.remote


# Setup commands
setup: |
  set -e

  # Install uv if not present
  if ! command -v uv &> /dev/null; then
    curl -LsSf https://astral.sh/uv/install.sh | sh
    source $HOME/.cargo/env
  fi

  # Install Python dependencies
  uv venv --python=3.11
  uv sync
  source .venv/bin/activate
  export CUDA_HOME=/usr/local/cuda-12.4
  export UV_TORCH_BACKEND=cu124
  uv pip install packaging setuptools wheel
  uv pip install torch==2.6.0
  uv pip install awscli pydantic
  MAX_JOBS=16 uv pip install --no-build-isolation axolotl[flash-attn,deepspeed]

  # Set up environment
  echo "Setup completed successfully"

# Run command
run: |
  set -e

  # Export environment variables
  export PYTHONPATH=/workspace/truesight:$PYTHONPATH
